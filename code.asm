VARS:

CNT DW 00H;total count of all participants
ROWCNT DB 00H,00H,00H,00H,00H,00H;individual row counts
GATE DB 0
STRLEN DB 0
EMPTY DB 'EMPTY'
FULL DB 'FULL'

;8255
PORTA EQU 00H
PORTB EQU 02H
PORTC EQU 04H
CWREG EQU 06H

JMP     ST1
DB     1001 DUP(0)

ST1:
;INIT REGISTERS TO RAM START
MOV       AX,02000H
MOV       DS,AX
MOV       ES,AX
MOV       SS,AX
MOV       SP,02FFEH

;INTIALISE PORTA AND PORTB AS INPUT & PORTC AS OUTPUT FOR 8255
MOV     AL,92H
OUT     CWREG,AL


MOV AL,00H
OUT 04H,AL

STARTUP:
CALL DELAY_1S
CALL DELAY_1S

;if sensor1 triggered first, entry
;if sensor2 triggered first, exit

;ENTRY CHECK
X1: IN AL,02H
AND AL,80H;door sensor to increase central count
CMP AL,80H
JNZ X2
Y1: IN AL,02H
AND AL,40H
CMP AL,40H
JNZ Y1
ADD CNT,1
MOV GATE,1

CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S

;EXIT CHECK
X2: IN AL,02H
AND AL,40H
CMP AL,40H
JNZ X5
Y2: IN AL,02H
AND AL,80H
CMP AL,80H
JNZ Y2
SUB CNT,1
MOV GATE,0

CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S
CALL DELAY


;R1 ENTRY
X5: IN AL,02H;port input
AND AL,08H;check if first row sensor 1 triggered
CMP AL,08H;if triggered, check if sensor 2 triggered to confirm entry
JNZ X6;if not triggered, go to exit check
Y5: IN AL,02H
AND AL,04H
CMP AL,04H
JNZ Y5;if sensor 2 not triggered, wait till trigger
ADD ROWCNT,1

CALL DELAY_1S
CALL DELAY_1S

;R1 EXIT
X6: IN AL,02H
AND AL,04H
CMP AL,04H;same as entry but sensor order reveresed
JNZ X7;if not triggered check for row2 entry
Y6: IN AL,02H
AND AL,08H
CMP AL,08H
JNZ Y6
SUB ROWCNT,1

CALL DELAY_1S
CALL DELAY_1S

;R2 ENTRY
X7: IN AL,02H
AND AL,02H
CMP AL,02H
JNZ X8
Y7: IN AL,02H
AND AL,01H
CMP AL,01H
JNZ Y7
ADD ROWCNT+1,1

CALL DELAY_1S
CALL DELAY_1S

;R2 EXIT
X8: IN AL,02H
AND AL,01H
CMP AL,01H
JNZ X9
Y8: IN AL,02H
AND AL,02H
CMP AL,02H
JNZ Y8
SUB ROWCNT+1,1

CALL DELAY_1S
CALL DELAY_1S

;R3 ENTRY
X9: IN AL,00H
AND AL,80H
CMP AL,80H
JNZ X10
Y9: IN AL,00H
AND AL,40H
CMP AL,40H
JNZ Y9
ADD ROWCNT+2,1

CALL DELAY_1S
CALL DELAY_1S

;R3 EXIT
X10: IN AL,00H
AND AL,40H
CMP AL,40H
JNZ X11
Y10: IN AL,00H
AND AL,80H
CMP AL,80H
JNZ Y10
SUB ROWCNT+2,1

CALL DELAY_1S
CALL DELAY_1S

;R4 ENTRY
X11: IN AL,00H
AND AL,20H
CMP AL,20H
JNZ X12
Y11: IN AL,00H
AND AL,10H
CMP AL,10H
JNZ Y11
ADD ROWCNT+3,1

CALL DELAY_1S
CALL DELAY_1S

;R4 EXIT
X12: IN AL,00H
AND AL,10H
CMP AL,10H
JNZ X13
Y12: IN AL,00H
AND AL,20H
CMP AL,20H
JNZ Y12
SUB ROWCNT+3,1

CALL DELAY_1S
CALL DELAY_1S

;R5 ENTRY
X13: IN AL,00H
AND AL,08H
CMP AL,08H
JNZ X14
Y13: IN AL,00H
AND AL,04H
CMP AL,04H
JNZ Y13
ADD ROWCNT+4,1

CALL DELAY_1S
CALL DELAY_1S

;R5 EXIT
X14: IN AL,00H
AND AL,04H
CMP AL,04H
JNZ X15
Y14: IN AL,00H
AND AL,08H
CMP AL,08H
JNZ Y14
SUB ROWCNT+4,1

CALL DELAY_1S
CALL DELAY_1S

;R6 ENTRY
X15: IN AL,00H
AND AL,02H
CMP AL,02H
JNZ X16
Y15: IN AL,00H
AND AL,01H
CMP AL,01H
JNZ Y15
ADD ROWCNT+5,1

CALL DELAY_1S
CALL DELAY_1S

;R6 EXIT
X16: IN AL,00H
AND AL,01H
CMP AL,01H
JNZ X
Y16: IN AL,00H
AND AL,02H
CMP AL,02H
JNZ Y16
SUB ROWCNT+5,1

CALL DELAY_1S
CALL DELAY_1S


X:  MOV AL,00000000B
MOV BL,00000001B
MOV CX,06H
LEA SI,ROWCNT
Y:  MOV DL,[SI]
CMP DL,00H
JNZ Z
JMP W
Z:  OR AL,BL

W:  ROL BL,1
ADD SI,1
DEC CX
CMP CX,00H
JNZ Y
OUT 04H,AL
CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S
CALL DELAY_1S


DISP:
JMP X1


DELAY_1S PROC
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
CALL DELAY
RET
DELAY_1S ENDP

DELAY PROC
MOV CX, 1325 ;1325*15.085 USEC = 20 MSEC
W1:
NOP
NOP
NOP
NOP
NOP
LOOP W1
RET
DELAY ENDP





